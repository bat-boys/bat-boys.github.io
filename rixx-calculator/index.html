<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rixx calculator</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css"
      integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="../style.css" />
  </head>
  <body>
    <div id="app">
      <div class="header">
        <h1>Rixx calculator</h1>
        <h2>{{ maxzin > 0 ? `Zinium required: ${maxzin}` : "^o^" }}</h2>
      </div>
      <div class="pure-g">
        <div class="pure-u-1-3">
          <div class="box">
            <div class="pure-g">
              <div class="pure-u-1-2">
                <h3>
                  Runes
                  <span class="h3-additional">
                    ({{ filteredRunes.length }}/{{ runes.length}} shown)
                  </span>
                </h3>
              </div>
              <div class="pure-u-1-2 align-right">
                <a class="pure-button" @click="showfilters = !showfilters">
                  {{ showfilters ? "hide" : "show" }} filters
                </a>
              </div>
            </div>
          </div>
          <div class="rune-filter" v-show="showfilters">
            <form class="pure-form pure-form-aligned">
              <fieldset>
                <div class="pure-control-group">
                  <label>search</label>
                  <input
                    type="text"
                    id="rune-filter-equipment"
                    v-model="textfilter"
                  />
                </div>
                <div class="pure-control-group">
                  <label for="aligned-name">{{ zinabs }} zin</label>
                  <input
                    type="range"
                    id="aligned-name"
                    min="0"
                    max="100"
                    v-model="zinpct"
                  />
                </div>
                <div class="pure-control-group">
                  <label>
                    slots
                  </label>
                  <input
                    type="checkbox"
                    id="runefilter-slots-0"
                    v-model="checked.slots0"
                  />
                  <=0
                  <input
                    type="checkbox"
                    id="runefilter-slots-1"
                    v-model="checked.slots1"
                  />
                  1
                  <input
                    type="checkbox"
                    id="runefilter-slots-2"
                    v-model="checked.slots2"
                  />
                  2
                  <input
                    type="checkbox"
                    id="runefilter-slots-4"
                    v-model="checked.slots4"
                  />
                  >=4
                </div>
                <div class="box align-right">
                  <a class="pure-button" @click="toggletypes">
                    {{ typesselected ? "deselect" : "select" }} all types
                  </a>
                </div>
                <div class="pure-g">
                  <div class="pure-u-1-2 two-column">
                    <div class="pure-control-group">
                      <label>equipment</label>
                      <input
                        type="checkbox"
                        id="rune-filter-equipment"
                        v-model="checked.equipment"
                      />
                    </div>
                    <div class="pure-control-group">
                      <label>stat</label>
                      <input
                        type="checkbox"
                        id="rune-filter-stat"
                        v-model="checked.stat"
                      />
                    </div>
                    <div class="pure-control-group">
                      <label>bonus</label>
                      <input
                        type="checkbox"
                        id="rune-filter-bonus"
                        v-model="checked.bonus"
                      />
                    </div>
                    <div class="pure-control-group">
                      <label>hp/sp/ep max</label>
                      <input
                        type="checkbox"
                        id="rune-filter-hpspepmax"
                        v-model="checked.hpspepmax"
                      />
                    </div>
                    <div class="pure-control-group">
                      <label>spell/skill</label>
                      <input
                        type="checkbox"
                        id="rune-filter-spellskill"
                        v-model="checked.spellskill"
                      />
                    </div>
                  </div>
                  <div class="pure-u-1-2 two-column">
                    <div class="pure-control-group">
                      <label>weight</label>
                      <input
                        type="checkbox"
                        id="rune-filter-weight"
                        v-model="checked.weight"
                      />
                    </div>
                    <div class="pure-control-group">
                      <label>exp rate</label>
                      <input
                        type="checkbox"
                        id="rune-filter-exprate"
                        v-model="checked.exprate"
                      />
                    </div>
                    <div class="pure-control-group">
                      <label>haste</label>
                      <input
                        type="checkbox"
                        id="rune-filter-haste"
                        v-model="checked.haste"
                      />
                    </div>
                    <div class="pure-control-group">
                      <label>special</label>
                      <input
                        type="checkbox"
                        id="rune-filter-special"
                        v-model="checked.special"
                      />
                    </div>
                  </div>
                </div>
              </fieldset>
            </form>
          </div>
          <draggable v-model="filteredRunes" group="runes">
            <rune
              v-for="rune in filteredRunes"
              :key="`item${rune.index}`"
              :rune="rune"
            >
            </rune>
          </draggable>
        </div>
        <div class="pure-u-1-3">
          <div class="equipment">
            <div class="box">
              <h3>
                Equipment 1
                <span class="h3-additional">
                  ({{ rixxeq1slots }} slots available)
                </span>
              </h3>
            </div>
            <draggable v-model="rixxeq1" group="runes">
              <rune v-for="rune in rixxeq1" :key="rune.index" :rune="rune">
              </rune>
              <div class="box empty" v-show="rixxeq1.length === 0">
                Create a new equipment by dragging equipment runes here
              </div>
            </draggable>
          </div>
          <div class="equipment" v-if="rixxeq2.length > 0">
            <div class="box">
              <h3>
                Equipment 3
                <span class="h3-additional">
                  ({{ rixxeq3slots }} slots available)
                </span>
              </h3>
            </div>
            <draggable v-model="rixxeq3" group="runes">
              <rune v-for="rune in rixxeq3" :key="rune.index" :rune="rune">
              </rune>
              <div class="box empty" v-show="rixxeq3.length === 0">
                Create a new equipment by dragging equipment runes here
              </div>
            </draggable>
          </div>
        </div>
        <div class="pure-u-1-3">
          <div class="equipment" v-if="rixxeq1.length > 0">
            <div class="box">
              <h3>
                Equipment 2
                <span class="h3-additional">
                  ({{ rixxeq2slots }} slots available)
                </span>
              </h3>
            </div>
            <draggable v-model="rixxeq2" group="runes">
              <rune v-for="rune in rixxeq2" :key="rune.index" :rune="rune">
              </rune>
              <div class="box empty" v-show="rixxeq2.length === 0">
                Create a new equipment by dragging equipment runes here
              </div>
            </draggable>
          </div>
          <div class="equipment">
            <div class="box">
              <h3>
                Other equipments
              </h3>
            </div>
            <draggable v-model="othereq" group="runes">
              <rune v-for="rune in othereq" :key="rune.index" :rune="rune">
              </rune>
              <div class="box empty" v-show="othereq.length === 0">
                Add non-rixx equipment runes here
              </div>
            </draggable>
          </div>
        </div>
      </div>
      <div id="app"></div>
    </div>
    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/sortablejs@1.10.2"></script>
    <script src="https://unpkg.com/vue-draggable-plus"></script>
    <script>
      const mapLogarithmic = (value, inMin, inMax, outMin, outMax) => {
        const inRange = inMax - inMin;
        const outRange = Math.log(outMax / outMin);
        const scale = outRange / inRange;

        return Math.exp(scale * (value - inMin)) * outMin;
      };

      const sum = (arr) => arr.reduce((a, b) => a + b, 0);
      const max = (arr) => Math.max(...arr);

      const Rune = {
        props: ["rune"],
        template: `
        <div class="box rune">
          <div class="pure-g">
            <div class="pure-u-1-3">
              <div class="left">
                <span class="index">{{ rune.index }} #&nbsp;&nbsp;</span><br /><br />
                <span class="zincost">{{ rune.zinium }} zin</span><br />
                <span class="slots">
                  {{ rune.slots > 0 ? "+" : "" }}{{ rune.slots }} slo </span><br />
                <span class="blueprint" v-if="rune.blueprint">
                  {{ rune.blueprint }} bp&nbsp;
                </span>
              </div>
            </div>
            <div class="pure-u-2-3">
              <div class="right">
                <span class="shortname">{{ rune.shortname }}</span
                ><br /><br />
                <span class="longname">{{ rune.longname }}</span><br />
              </div>
            </div>
          </div>
        </div>
        `,
      };

      const Equipment = {
        props: ["eq"],
        template: `

        `,
      };

      const app = Vue.createApp({
        data() {
          return {
            checked: {
              equipment: true,
              stat: true,
              bonus: true,
              hpspepmax: true,
              spellskill: true,
              weight: true,
              exprate: true,
              haste: true,
              special: true,
              slots0: true,
              slots1: true,
              slots2: true,
              slots4: true,
            },
            runes: [],
            zinpct: 44,
            showfilters: true,
            textfilter: "",
            rixxeq1: [],
            rixxeq2: [],
            rixxeq3: [],
            othereq: [],
          };
        },
        created() {
          fetch("data.json")
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((data) => {
              this.runes = data;
              this.parsequeryparams();
            })
            .catch((error) => {
              console.error("There was a problem loading the data:", error);
            });
        },
        components: {
          draggable: VueDraggablePlus.VueDraggable,
          Rune,
        },
        computed: {
          filteredRunes() {
            return this.runes
              .filter(
                (rune) =>
                  // rune is in equipment
                  !this.rixxeq1ids.includes(rune.index) &&
                  !this.rixxeq2ids.includes(rune.index) &&
                  !this.rixxeq3ids.includes(rune.index) &&
                  // text
                  (rune.shortname
                    .toLowerCase()
                    .includes(this.textfilter.toLowerCase()) ||
                    rune.longname
                      .toLowerCase()
                      .includes(this.textfilter.toLowerCase()) ||
                    (rune.blueprint &&
                      rune.blueprint
                        .toLowerCase()
                        .includes(this.textfilter.toLowerCase()))) &&
                  // zin
                  rune.zinium <= this.zinabs &&
                  // type
                  ((this.checked.equipment &&
                    rune.tags.includes("equipment")) ||
                    (this.checked.stat && rune.tags.includes("stat")) ||
                    (this.checked.bonus && rune.tags.includes("bonus")) ||
                    (this.checked.hpspepmax &&
                      rune.tags.includes("hpspepmax")) ||
                    (this.checked.spellskill &&
                      rune.tags.includes("spellskill")) ||
                    (this.checked.weight && rune.tags.includes("weight")) ||
                    (this.checked.exprate && rune.tags.includes("exprate")) ||
                    (this.checked.haste && rune.tags.includes("haste")) ||
                    (this.checked.special && rune.tags.includes("special"))) &&
                  // slots
                  ((this.checked.slots0 && rune.slots >= 0) ||
                    (this.checked.slots1 && rune.slots === -1) ||
                    (this.checked.slots2 && rune.slots === -2) ||
                    (this.checked.slots4 && rune.slots <= -4))
              )
              .sort((a, b) => a.index - b.index);
          },
          typesselected() {
            return (
              this.checked.equipment &&
              this.checked.stat &&
              this.checked.bonus &&
              this.checked.hpspepmax &&
              this.checked.spellskill &&
              this.checked.weight &&
              this.checked.exprate &&
              this.checked.haste &&
              this.checked.special
            );
          },
          zinabs() {
            return Math.round(mapLogarithmic(this.zinpct, 0, 100, 50, 50000));
          },
          rixxeq1ids() {
            return this.rixxeq1.map((rune) => rune.index);
          },
          rixxeq2ids() {
            return this.rixxeq2.map((rune) => rune.index);
          },
          rixxeq3ids() {
            return this.rixxeq3.map((rune) => rune.index);
          },
          othereqids() {
            return this.othereq.map((rune) => rune.index);
          },
          rixxeq1slots() {
            return sum(this.rixxeq1.map((rune) => rune.slots));
          },
          rixxeq2slots() {
            return sum(this.rixxeq2.map((rune) => rune.slots));
          },
          rixxeq3slots() {
            return sum(this.rixxeq3.map((rune) => rune.slots));
          },
          maxzin() {
            const runes = this.rixxeq1
              .concat(this.rixxeq2)
              .concat(this.rixxeq3);
            return max(runes.map((rune) => rune.zinium));
          },
          queryparams() {
            const url = new URL(window.location.href);
            if (this.rixxeq1ids.length > 0) {
              url.searchParams.set("eq1", this.rixxeq1ids.join(","));
            } else {
              url.searchParams.delete("eq1");
            }
            if (this.rixxeq2ids.length > 0) {
              url.searchParams.set("eq2", this.rixxeq2ids.join(","));
            } else {
              url.searchParams.delete("eq2");
            }
            if (this.rixxeq3ids.length > 0) {
              url.searchParams.set("eq3", this.rixxeq3ids.join(","));
            } else {
              url.searchParams.delete("eq3");
            }
            if (this.othereqids.length > 0) {
              url.searchParams.set("othereq", this.othereqids.join(","));
            } else {
              url.searchParams.delete("othereq");
            }
            return url.searchParams.toString();
          },
        },
        methods: {
          toggletypes(event) {
            if (this.typesselected) {
              this.checked.equipment = false;
              this.checked.stat = false;
              this.checked.bonus = false;
              this.checked.hpspepmax = false;
              this.checked.spellskill = false;
              this.checked.weight = false;
              this.checked.exprate = false;
              this.checked.haste = false;
              this.checked.special = false;
            } else {
              this.checked.equipment = true;
              this.checked.stat = true;
              this.checked.bonus = true;
              this.checked.hpspepmax = true;
              this.checked.spellskill = true;
              this.checked.weight = true;
              this.checked.exprate = true;
              this.checked.haste = true;
              this.checked.special = true;
            }
          },
          parsequeryparams() {
            const url = new URL(window.location.href);
            const eq1 = url.searchParams.get("eq1");
            const eq2 = url.searchParams.get("eq2");
            const eq3 = url.searchParams.get("eq3");
            const othereq = url.searchParams.get("othereq");
            if (eq1) {
              this.rixxeq1 = eq1.split(",").map((id) => {
                return this.runes.find((rune) => rune.index === parseInt(id));
              });
            }
            if (eq2) {
              this.rixxeq2 = eq2.split(",").map((id) => {
                return this.runes.find((rune) => rune.index === parseInt(id));
              });
            }
            if (eq3) {
              this.rixxeq3 = eq3.split(",").map((id) => {
                return this.runes.find((rune) => rune.index === parseInt(id));
              });
            }
            if (othereq) {
              this.othereq = othereq.split(",").map((id) => {
                return this.runes.find((rune) => rune.index === parseInt(id));
              });
            }
          },
        },
        watch: {
          queryparams() {
            window.history.replaceState(
              null,
              null,
              window.location.pathname + "?" + this.queryparams
            );
          },
        },
      });

      app.mount("#app");
    </script>
  </body>
</html>
