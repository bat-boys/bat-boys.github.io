<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rixx calculator</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/purecss@3.0.0/build/pure-min.css"
      integrity="sha384-X38yfunGUhNzHpBaEBsWLO+A0HDYOQi8ufWDkZ0k9e0eXz/tH3II7uKZ9msv++Ls"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="../style.css" />
  </head>
  <body>
    <div id="app">
      <div class="header">
        <h1>Rixx calculator</h1>
        <h2>{{ maxzin > 0 ? `Zinium required: ${maxzin}` : "^o^" }}</h2>
      </div>
      <div class="pure-g">
        <div class="pure-u-1-3">
          <div class="box">
            <div class="pure-g">
              <div class="pure-u-1-2">
                <h3>
                  Runes
                  <span class="h3-additional">
                    ({{ filteredRunes.length }}/{{ runes.length}} shown)
                  </span>
                </h3>
              </div>
              <div class="pure-u-1-2 align-right">
                <a class="pure-button" @click="showfilters = !showfilters">
                  {{ showfilters ? "hide" : "show" }} filters
                </a>
              </div>
            </div>
          </div>
          <div class="rune-filter" v-show="showfilters">
            <form class="pure-form pure-form-aligned">
              <fieldset>
                <div class="pure-control-group">
                  <label>search</label>
                  <input
                    type="text"
                    id="rune-filter-equipment"
                    v-model="textfilter"
                  />
                </div>
                <div class="pure-control-group">
                  <label for="aligned-name">{{ zinabs }} zin</label>
                  <input
                    type="range"
                    id="aligned-name"
                    min="0"
                    max="100"
                    v-model="zinpct"
                  />
                </div>
                <div class="pure-control-group">
                  <label>
                    slots
                  </label>
                  <input
                    type="checkbox"
                    id="runefilter-slots-0"
                    v-model="checked.slots0"
                  />
                  <=0
                  <input
                    type="checkbox"
                    id="runefilter-slots-1"
                    v-model="checked.slots1"
                  />
                  1
                  <input
                    type="checkbox"
                    id="runefilter-slots-2"
                    v-model="checked.slots2"
                  />
                  2
                  <input
                    type="checkbox"
                    id="runefilter-slots-4"
                    v-model="checked.slots4"
                  />
                  >=4
                </div>
                <div class="box align-right">
                  <a class="pure-button" @click="toggletypes">
                    {{ typesselected ? "deselect" : "select" }} all types
                  </a>
                </div>
                <div class="pure-g">
                  <div class="pure-u-1-2 two-column">
                    <div class="pure-control-group">
                      <label>equipment</label>
                      <input
                        type="checkbox"
                        id="rune-filter-equipment"
                        v-model="checked.equipment"
                      />
                    </div>
                    <div class="pure-control-group">
                      <label>stat</label>
                      <input
                        type="checkbox"
                        id="rune-filter-stat"
                        v-model="checked.stat"
                      />
                    </div>
                    <div class="pure-control-group">
                      <label>bonus</label>
                      <input
                        type="checkbox"
                        id="rune-filter-bonus"
                        v-model="checked.bonus"
                      />
                    </div>
                    <div class="pure-control-group">
                      <label>hp/sp/ep max</label>
                      <input
                        type="checkbox"
                        id="rune-filter-hpspepmax"
                        v-model="checked.hpspepmax"
                      />
                    </div>
                    <div class="pure-control-group">
                      <label>spell/skill</label>
                      <input
                        type="checkbox"
                        id="rune-filter-spellskill"
                        v-model="checked.spellskill"
                      />
                    </div>
                  </div>
                  <div class="pure-u-1-2 two-column">
                    <div class="pure-control-group">
                      <label>weight</label>
                      <input
                        type="checkbox"
                        id="rune-filter-weight"
                        v-model="checked.weight"
                      />
                    </div>
                    <div class="pure-control-group">
                      <label>exp rate</label>
                      <input
                        type="checkbox"
                        id="rune-filter-exprate"
                        v-model="checked.exprate"
                      />
                    </div>
                    <div class="pure-control-group">
                      <label>haste</label>
                      <input
                        type="checkbox"
                        id="rune-filter-haste"
                        v-model="checked.haste"
                      />
                    </div>
                    <div class="pure-control-group">
                      <label>special</label>
                      <input
                        type="checkbox"
                        id="rune-filter-special"
                        v-model="checked.special"
                      />
                    </div>
                  </div>
                </div>
              </fieldset>
            </form>
          </div>
          <draggable v-model="filteredRunes" group="runes">
            <template v-for="rune in filteredRunes" :key="`item${rune.index}`">
              <div class="box rune">
                <div class="pure-g">
                  <div class="pure-u-1-3">
                    <div class="left">
                      <span class="index">{{ rune.index }} #&nbsp;&nbsp;</span
                      ><br /><br />
                      <span class="zincost">{{ rune.zinium }} zin</span><br />
                      <span class="slots">
                        {{ rune.slots > 0 ? "+" : "" }}{{ rune.slots }} slo </span
                      ><br />
                      <span class="blueprint" v-if="rune.blueprint"
                        >{{ rune.blueprint }} bp&nbsp;</span
                      >
                    </div>
                  </div>
                  <div class="pure-u-2-3">
                    <div class="right">
                      <span class="shortname">{{ rune.shortname }}</span
                      ><br /><br />
                      <span class="longname">{{ rune.longname }}</span><br />
                    </div>
                  </div>
                </div>
              </div>
            </template>
          </draggable>
        </div>
        <div class="pure-u-1-3">
          <div class="equipment">
            <div class="box">
              <h3>
                Equipment 1
                <span class="h3-additional">
                  ({{ eq1slots }} slots available)
                </span>
              </h3>
            </div>
            <draggable v-model="eq1" group="runes">
              <template v-for="rune in eq1" :key="`item${rune.index}`">
                <div class="box rune">
                  <div class="pure-g">
                    <div class="pure-u-1-3">
                      <div class="left">
                        <span class="index">{{ rune.index }} #&nbsp;&nbsp;</span
                        ><br /><br />
                        <span class="zincost">{{ rune.zinium }} zin</span><br />
                        <span class="slots">
                          {{ rune.slots > 0 ? "+" : "" }}{{ rune.slots }} slo </span
                        ><br />
                        <span class="blueprint" v-if="rune.blueprint"
                          >{{ rune.blueprint }} bp&nbsp;</span
                        >
                      </div>
                    </div>
                    <div class="pure-u-2-3">
                      <div class="right">
                        <span class="shortname">{{ rune.shortname }}</span
                        ><br /><br />
                        <span class="longname">{{ rune.longname }}</span><br />
                      </div>
                    </div>
                  </div>
                </div>
              </template>
              <div class="box empty" v-show="eq1.length === 0">
                fds
              </div>
            </draggable>
            <div class="box"><h3>Equipment 3</h3></div>
            <div class="box empty">
              fds
            </div>
          </div>
        </div>
        <div class="pure-u-1-3">
          <div class="box"><h3>Equipment 2</h3></div>
        </div>
      </div>
      <div id="app"></div>
    </div>
    <script src="https://unpkg.com/vue"></script>
    <script src="https://unpkg.com/sortablejs@1.10.2"></script>
    <script src="https://unpkg.com/vue-draggable-plus"></script>
    <script>
      const mapLogarithmic = (value, inMin, inMax, outMin, outMax) => {
        const inRange = inMax - inMin;
        const outRange = Math.log(outMax / outMin);
        const scale = outRange / inRange;

        return Math.exp(scale * (value - inMin)) * outMin;
      };

      const sum = (arr) => arr.reduce((a, b) => a + b, 0);
      const max = (arr) => Math.max(...arr);

      const app = Vue.createApp({
        data() {
          return {
            checked: {
              equipment: true,
              stat: true,
              bonus: true,
              hpspepmax: true,
              spellskill: true,
              weight: true,
              exprate: true,
              haste: true,
              special: true,
              slots0: true,
              slots1: true,
              slots2: true,
              slots4: true,
            },
            runes: [],
            zinpct: 44,
            showfilters: true,
            textfilter: "",
            eq1: [],
            eq2: [],
            eq3: [],
            eqother: [],
          };
        },
        created() {
          fetch("data.json")
            .then((response) => {
              if (!response.ok) {
                throw new Error("Network response was not ok");
              }
              return response.json();
            })
            .then((data) => (this.runes = data))
            .catch((error) => {
              console.error("There was a problem loading the data:", error);
            });
        },
        components: {
          draggable: VueDraggablePlus.VueDraggable,
        },
        computed: {
          filteredRunes() {
            return this.runes.filter(
              (rune) =>
                // rune is in equipment
                !this.eq1ids.includes(rune.index) &&
                !this.eq2ids.includes(rune.index) &&
                !this.eq3ids.includes(rune.index) &&
                !this.eqotherids.includes(rune.index) &&
                // text
                (rune.shortname
                  .toLowerCase()
                  .includes(this.textfilter.toLowerCase()) ||
                  rune.longname
                    .toLowerCase()
                    .includes(this.textfilter.toLowerCase()) ||
                  (rune.blueprint &&
                    rune.blueprint
                      .toLowerCase()
                      .includes(this.textfilter.toLowerCase()))) &&
                // zin
                rune.zinium <= this.zinabs &&
                // type
                ((this.checked.equipment && rune.tags.includes("equipment")) ||
                  (this.checked.stat && rune.tags.includes("stat")) ||
                  (this.checked.bonus && rune.tags.includes("bonus")) ||
                  (this.checked.hpspepmax && rune.tags.includes("hpspepmax")) ||
                  (this.checked.spellskill &&
                    rune.tags.includes("spellskill")) ||
                  (this.checked.weight && rune.tags.includes("weight")) ||
                  (this.checked.exprate && rune.tags.includes("exprate")) ||
                  (this.checked.haste && rune.tags.includes("haste")) ||
                  (this.checked.special && rune.tags.includes("special"))) &&
                // slots
                ((this.checked.slots0 && rune.slots >= 0) ||
                  (this.checked.slots1 && rune.slots === -1) ||
                  (this.checked.slots2 && rune.slots === -2) ||
                  (this.checked.slots4 && rune.slots <= -4))
            );
          },
          typesselected() {
            return (
              this.checked.equipment &&
              this.checked.stat &&
              this.checked.bonus &&
              this.checked.hpspepmax &&
              this.checked.spellskill &&
              this.checked.weight &&
              this.checked.exprate &&
              this.checked.haste &&
              this.checked.special
            );
          },
          zinabs() {
            return Math.round(mapLogarithmic(this.zinpct, 0, 100, 50, 50000));
          },
          eq1ids() {
            return this.eq1.map((rune) => rune.index);
          },
          eq2ids() {
            return this.eq2.map((rune) => rune.index);
          },
          eq3ids() {
            return this.eq3.map((rune) => rune.index);
          },
          eqotherids() {
            return this.eqother.map((rune) => rune.index);
          },
          eq1slots() {
            return sum(this.eq1.map((rune) => rune.slots));
          },
          eq2slots() {
            return sum(this.eq2.map((rune) => rune.slots));
          },
          eq3slots() {
            return sum(this.eq3.map((rune) => rune.slots));
          },
          maxzin() {
            const runes = this.eq1.concat(this.eq2).concat(this.eq3);
            return max(runes.map((rune) => rune.zinium));
          },
        },
        methods: {
          toggletypes(event) {
            if (this.typesselected) {
              this.checked.equipment = false;
              this.checked.stat = false;
              this.checked.bonus = false;
              this.checked.hpspepmax = false;
              this.checked.spellskill = false;
              this.checked.weight = false;
              this.checked.exprate = false;
              this.checked.haste = false;
              this.checked.special = false;
            } else {
              this.checked.equipment = true;
              this.checked.stat = true;
              this.checked.bonus = true;
              this.checked.hpspepmax = true;
              this.checked.spellskill = true;
              this.checked.weight = true;
              this.checked.exprate = true;
              this.checked.haste = true;
              this.checked.special = true;
            }
          },
        },
      });

      app.mount("#app");
    </script>
  </body>
</html>
